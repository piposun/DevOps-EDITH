pipeline {
    agent any
    tools {
        maven 'Maven 3.3.9'
        jdk 'jdk8'
    }
    stages {
        stage ('Initialize') {
            steps {
                sh'''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }
        stage ('Deploy') {
            steps {
                withCredentials([file(credentialsId: "${JENKINS_GCLOUD_CRED_ID}", variable: 'JENKINSGCLOUDCREDENTIAL')])
                         {
                        sh'gcloud container clusters get-credentials ${GCLOUD_K8S_CLUSTER_NAME}'
                }
            }
       	}
       	
    	stage('Deploy Application on K8s') {
        container('kubectl'){
            withKubeConfig([credentialsId: env.K8s_CREDENTIALS_ID,
            serverUrl: env.K8s_SERVER_URL,
            contextName: env.K8s_CONTEXT_NAME,
            clusterName: env.K8s_CLUSTER_NAME]){
                sh'kubectl apply -f config.yml'
                sh'kubectl apply -f ${app1_name}.yml'
                sh'kubectl set image deployment/${app1_name} ${app1_container_name}=${app1_image_tag}'
            }
        }
   }
}