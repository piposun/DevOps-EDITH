pipeline {
    agent any
    tools {
        maven 'Maven 3.3.9'
        jdk 'jdk8'
    }
    stages {
        stage ('Initialize') {
            steps {
                sh '''
                    echo "PATH = ${PATH}"
                    echo "M2_HOME = ${M2_HOME}"
                '''
            }
        }
        stage ('Build') {
            steps {
                sh 'mvn clean install'
            }
        }
        
        stage ('Docker build'){
        	steps{
        	   sh 'docker build . -t eu.gcr.io/edith-259213/edith:$BUILD_NUMBER'
        	}
        }
        
        stage ('Push the image on GCR'){
        	steps{
        	   sh '''
        	   gcloud auth configure-docker --quiet
        	   docker push eu.gcr.io/edith-259213/edith:$BUILD_NUMBER
        	   '''
        	}
        }
        
        stage ('Update image version'){
           steps{
				sh'sed -i s/BUILD_NUMBER/$BUILD_NUMBER/ Deploy/edith-deployment.yaml'
           }
        }
        
        stage ('Commit/Push edit-deployment.yaml'){
           steps{
           withCredentials([usernamePassword(credentialsId: 'f035962a-8254-4090-90c3-8e1a633792bf', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
				sh'''
				git config --global user.name "Jenkins"
    			git config --global user.email jenkins@example.com
				git add Deploy/edith-deployment.yaml
				git commit -m "Update image version (from jenkins_CI)"
				git push origin HEAD:master
				'''
				
                    }
           }
        }
  
        stage ('Finished'){
           steps{
				sh 'echo "Pipeline finished"'
           }
        }
    }
}